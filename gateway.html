<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- â–¼â–¼â–¼ ë³´í˜¸ í˜ì´ì§€ ê³µí†µ: <head> ë§¨ ìœ„ì— ë„£ê¸° â–¼â–¼â–¼ -->
  <meta charset="UTF-8" />
  <style> html.auth-check { visibility: hidden } </style>
  <style>
  /* ...ì „ê´‘íŒ í˜ì´ë“œì¸ */
  #hdr-rotator{ position:relative; min-height:24px; }
  #hdr-rotator .rot-line{
    position:absolute; inset:0;
    opacity:0; transform:translateY(8px);
    transition:opacity .4s ease, transform .4s ease;
    will-change:opacity,transform;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  #hdr-rotator .rot-line.show{
    opacity:1; transform:translateY(0);
  }
</style>

  <script>
    // UI ê¹œë¹¡ì„ ë°©ì§€: ì¸ì¦ ëë‚  ë•Œê¹Œì§€ ìˆ¨ê¹€
    document.documentElement.classList.add('auth-check');

    // ë¡œê·¸ì¸ í˜ì´ì§€ ê²½ë¡œ (í•„ìš”ì‹œ ìƒëŒ€ê²½ë¡œ ì¡°ì •)
    window.__LOGIN_PAGE__ = 'login.html';

    // Cognito User Pool ì„¤ì •
    window.__POOL__ = {
      UserPoolId: 'ap-northeast-2_jubP19tft', // â† ì‹¤ì œ ê°’
      ClientId:   '2mpr21p7900br0n3p03g8f9ota', // â† ì‹¤ì œ ê°’
    };
  </script>

  <!-- Cognito SDKë“¤ (ìˆœì„œ ì¤‘ìš”) -->
  <!-- <script src="aws-sdk.min.js"></script> -->
  <script src="aws-cognito-sdk.min.js"></script>
  <script src="amazon-cognito-identity.min.js"></script>

  <!-- ì¸ì¦ ê°€ë“œ -->
  <script>
    (function authGuard() {
      function goLogin() {
        const u = new URL(window.__LOGIN_PAGE__, location.href);
        u.searchParams.set('redirect', location.href); // ë¡œê·¸ì¸ í›„ ëŒì•„ì˜¬ ê³³
        location.replace(u.toString());
      }

      // SDK ë¡œë“œ ëŒ€ê¸° í›„ ì‹¤í–‰
      (function waitLib(){
        if (!window.AmazonCognitoIdentity){ return setTimeout(waitLib, 20); }
        try{
          const pool = new AmazonCognitoIdentity.CognitoUserPool(window.__POOL__);

          // ğŸ”¸ ë¸Œë¼ìš°ì € ì„¸ì…˜ í”Œë˜ê·¸ê°€ ì—†ìœ¼ë©´ ê°•ì œ ì¬ë¡œê·¸ì¸
          if (!sessionStorage.getItem('app_session')) {
            const u = pool.getCurrentUser();
            if (u) { try { u.signOut(); } catch(e){} } // ë‚¨ì•„ìˆë˜ í† í° ì •ë¦¬
            return goLogin();
          }

          const user = pool.getCurrentUser();
          if (!user) return goLogin();

          user.getSession(function(err, session){
            if (err || !session || !session.isValid()) return goLogin();

            try {
              const groups = (session.getIdToken().payload || {})['cognito:groups'] || [];
              sessionStorage.setItem('app_is_admin', groups.includes('admin') ? '1' : '0');
            } catch {}


            // í˜ì´ì§€ í‘œì‹œ
            document.documentElement.classList.remove('auth-check');

            // âœ… ì´ë©”ì¼(ì—†ìœ¼ë©´ username) ì½ì–´ì„œ ì„¸ì…˜ìºì‹œì— ì €ì¥ + ì¦‰ì‹œ í‘œì‹œ ì‹œë„
            user.getUserAttributes(function(e, attrs){
              let email = (typeof user.getUsername === 'function') ? user.getUsername() : '';
              if (!e && Array.isArray(attrs)) {
                const em = attrs.find(a => (a.getName && a.getName() === 'email') || a?.Name === 'email');
                if (em) email = (em.getValue ? em.getValue() : em.Value);
              }

              try { sessionStorage.setItem('app_user_email', email); } catch {}

              // ê³µí†µ ì‚¬ì´ë“œë°” ì¸ì‚¬ë§ í‘œì‹œ
              try { window.__showSidebarGreet && window.__showSidebarGreet(email); } catch {}
            });
          });
        }catch(e){
          goLogin();
        }
      })();
    })();
  </script>
  <!-- â–²â–²â–² ì—¬ê¸°ê¹Œì§€ê°€ 'ë¬´ì¡°ê±´ ë¡œê·¸ì¸ ë¨¼ì €' ê°€ë“œ â–²â–²â–² -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tag Monitor</title>

  <!-- Favicon / Fonts / Icons / Tailwind -->
  <link rel="shortcut icon" href="https://example-s3-3.s3.ap-northeast-2.amazonaws.com/images.PNG" type="image/x-icon" sizes="16x16">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary:'#1E88E5', secondary:'#F5F6FA' },
          borderRadius: {
            'none':'0px','sm':'4px', DEFAULT:'8px','md':'12px','lg':'16px',
            'xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'
          }
        }
      }
    }
  </script>

  <!-- â˜… ê³µí†µ UI CSS -->
  <link rel="stylesheet" href="./ui-common.css" />

  <style>
    body{font-family:'Noto Sans KR',sans-serif;background:#f8fafc}
    .mono{font-family:'Roboto Mono',monospace}
  </style>
</head>
<body>
  <!-- â˜… ê³µí†µ ë ˆì´ì•„ì›ƒ(sj-shell) -->
  <div class="sj-shell">
    <!-- ê³µí†µ ì‚¬ì´ë“œë°”: ìë™ ë Œë” -->
    <aside class="sj-sidebar" data-sj-sidebar></aside>

    <!-- ë©”ì¸ -->
    <main class="sj-main">
      <!-- ê³µí†µ í—¤ë” -->
      <header class="sj-header">
        <div class="sj-title text-sm">
          
          <span id="total-count" class="ml-2 text-xs text-gray-400"></span>
        </div>
        <!-- ì „ê´‘íŒ(ê³µí†µ ë¡œí…Œì´í„°) -->
        <div data-sj-rotator id="hdr-rotator" class="w-[240px] sm:w-[320px] md:w-[480px]"></div>
      </header>

      <!-- í˜ì´ì§€ ì½˜í…ì¸  -->
      <section class="p-6">
        <div class="mb-6 flex items-end justify-between">
          <div>
            <h1 class="text-xl font-bold text-gray-800">ê²Œì´íŠ¸ì›¨ì´ ëª¨ë‹ˆí„°ë§</h1>
          </div>
          <div class="flex items-center gap-2 text-xs">
            <span class="hidden sm:inline text-gray-300"> </span>
            <button id="refresh-list" class="px-2 py-1 border rounded-md bg-white hover:bg-gray-50">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>

        <!-- â–¼ ê²€ìƒ‰ + í‘œ -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <div class="p-3 flex items-center justify-between gap-2 text-xs">
            <div id="gw-list-title" class="text-gray-700 font-medium">ê²Œì´íŠ¸ì›¨ì´ ëª©ë¡ (0)</div>
            <div class="relative shrink-0">
              <i class="ri-search-line text-gray-400 absolute left-2 top-1/2 -translate-y-1/2 text-sm"></i>
              <input id="search" type="text" placeholder="ê²Œì´íŠ¸ì›¨ì´ ID ë˜ëŠ” ìƒíƒœ ê²€ìƒ‰â€¦"
                    class="w-48 sm:w-60 md:w-72 pl-7 pr-3 py-1.5 text-sm border rounded-md bg-gray-50
                           focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-300">
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50 border-y border-gray-200">
                <tr class="text-gray-600">
                  <th class="px-3 py-2 text-left whitespace-nowrap">ê²Œì´íŠ¸ì›¨ì´ ID</th>
                  <th class="px-3 py-2 text-left whitespace-nowrap">ì´ë¦„</th>
                  <th class="px-3 py-2 text-left whitespace-nowrap">ìœ„ì¹˜</th>
                  <th class="px-3 py-2 text-left whitespace-nowrap">íŒì›¨ì–´</th>
                  <th class="px-3 py-2 text-left whitespace-nowrap">íƒœê·¸ ìˆ˜</th>
                  <th class="px-3 py-2 text-left whitespace-nowrap">íŒì›¨ì–´ ì—…ë°ì´íŠ¸</th>
                </tr>
              </thead>
              <tbody id="table-body" class="divide-y divide-gray-100"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- â˜… ê³µí†µ UI JS (autoInitë¡œ ì‚¬ì´ë“œë°”/ë¡œí…Œì´í„° ìë™ ë°”ì¸ë”©) -->
  <script type="module" src="./ui-common.js"></script>

  <script type="module">
    import {
      buildTickerTextsFromDevices,
      publishAlerts,
      subscribeTickerFromOthers,
      macPretty
    } from './ticker-common.js';

    // ëª¨ë“  í˜ì´ì§€ì—ì„œ 1íšŒ
    subscribeTickerFromOthers();

    function updateTicker() {
      const texts = buildTickerTextsFromDevices({
        devicesMap: window.devices ?? new Map(),
        ids:        window.knownIds ?? [],
        activeMs:   60_000,
        // labeler: (id) => macPretty(id),
      });

      publishAlerts(
        texts.map(t => ({ text: t, level: 'info' })),
        { mode:'replace', staggerMs:1200, broadcast:true }
      );
    }

    // ì „ì—­ ë…¸ì¶œ(ë‹¤ë¥¸ ì½”ë“œê°€ í˜¸ì¶œ)
    window.updateTicker = updateTicker;

    // ê³µí†µ í—¤ë” ë¡œí…Œì´í„° ì¥ì°©(ì¼ë¶€ í™˜ê²½ì—ì„œ autoInit íƒ€ì´ë° ì´ìŠˆ ì˜ˆë°©)
    (function waitSJUI(){ if(!window.SJUI) return setTimeout(waitSJUI,20); window.SJUI.mountRotators?.(); })();

    // ì´ˆê¸°/ì£¼ê¸° í˜¸ì¶œ
    updateTicker();
    window.__tickerTimer ||= setInterval(updateTicker, 5000);
  </script>

  <!-- â˜… ì‚¬ì´ë“œë°” í•­ëª© êµ¬ì„± -->
  <script>
    window.__SJ_SIDEBAR__ = {
      logo: { text: 'Tag Monitor', href: 'design.html', iconSrc: '', version: 'v0.1' },
      search: false,
      sections: [
        { title: 'Main', items: [
          { icon: 'ri-time-line',         label: 'ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ', href: 'design.html',  activeMatch: 'design.html' },
          { icon: 'ri-device-line',       label: 'ë””ë°”ì´ìŠ¤ ìƒì„¸',   href: 'detail.html',  activeMatch: 'detail.html' },
          { icon: 'ri-price-tag-3-line',  label: 'íƒœê·¸',            href: 'tag.html',     activeMatch: 'tag.html' },
          { icon: 'ri-rfid-line',         label: 'ê²Œì´íŠ¸ì›¨ì´',      href: 'gateway.html', activeMatch: 'gateway.html' },
          { icon: 'ri-alarm-warning-line',label: 'ì•ŒëŒ',            href: 'alarm.html',   activeMatch: 'alarm.html' },
          { icon: 'ri-settings-3-line',   label: 'ì„¤ì •',            href: 'setting.html', activeMatch: 'setting.html' }
        ] }
      ],
      initiallyOpen: false
    };
  </script>

  <!-- â˜… ì¸ì‚¬ë§ ìŠ¬ë¡¯ ì£¼ì…(ê³µí†µ ì‚¬ì´ë“œë°” ë Œë” í›„) -->
  <script>
    (function mountGreetSlot(){
      function inject(){
        const root = document.querySelector('[data-sj-sidebar]');
        if (!root || document.getElementById('sidebar-greet')) return;
        const logo = root.querySelector('.sj-sidebar__logo');
        const box  = document.createElement('div');
        box.id = 'sidebar-greet';
        box.className = 'px-4 py-1 text-[12px] text-gray-700 hidden';
        box.innerHTML = '<span id="sidebar-greet-name"></span>ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!';
        if (logo && logo.parentNode) {
          logo.parentNode.insertBefore(box, logo.nextSibling);
        } else {
          root.appendChild(box);
        }
      }
      const run = () => setTimeout(inject, 0);
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run, { once: true });
      } else { run(); }
      window.__showSidebarGreet = function(email){
        try{
          email = email || sessionStorage.getItem('app_user_email') || '';
          const box  = document.getElementById('sidebar-greet');
          const name = document.getElementById('sidebar-greet-name');
          if (box && name && email){ name.textContent = email; box.classList.remove('hidden'); }
        }catch{}
      };
      setTimeout(()=> window.__showSidebarGreet && window.__showSidebarGreet(), 400);
    })();
  </script>

  <!-- ===== ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ ===== -->
  <script>
    // ===== ê³µí†µ ì„¤ì • =====
    const WS_URL = "wss://fskxd58gc3.execute-api.ap-northeast-2.amazonaws.com/dev";
    const API_BASE = "https://v9dhc7n563.execute-api.ap-northeast-2.amazonaws.com/dev";
    const ALLOWED_API = "https://ujoxjrept3.execute-api.ap-northeast-2.amazonaws.com/dev/example-user-ble-tag/allowed";
    const UPDATE_API = "https://ltewehlvgi.execute-api.ap-northeast-2.amazonaws.com/Update_Gateway"

    // â–¼ íƒœê·¸(ë””ë°”ì´ìŠ¤) ì»¬ë ‰ì…˜: ì „ê´‘íŒìš©
    const TAG_COLLECTION = "calculated_locations";

    // â–¼ ê²Œì´íŠ¸ì›¨ì´ ì»¬ë ‰ì…˜: í…Œì´ë¸”ìš©
    const GW_COLLECTION = "gateway_data";

    const ACTIVE_MS = 60 * 1000;
    const BACKFILL_LIMIT_PER_ID = 1;

    
    let __ALLOWED_TAG_KEYS = new Set(); // 12HEX í‚¤ ì§‘í•©
    let __ALLOWED_READY    = false;
    window.__ALLOWED_TAG_IDS = [];
    window.__ALLOWED_READY   = false;

    function macHex12(raw){
      const s = String(raw||'').toUpperCase().replace(/[^0-9A-F]/g,'');
      return /^[0-9A-F]{12}$/.test(s) ? s : null;
    }
    // í™”ë©´ í‘œì‹œìš©(ì½œë¡  ì¶”ê°€)
    function macPretty(raw){
      const h = macHex12(raw);
      return h ? h.match(/.{2}/g).join(':') : String(raw||'');
    }
    
    async function fetchAllowedTagIdsFromServer(){
        const me = currentEmail();
        __ALLOWED_TAG_KEYS = new Set();
        if (!me) { __ALLOWED_READY = true; return; }

        const token = await getIdToken();
        const url = new URL(ALLOWED_API);
        url.searchParams.set('user_id', me);
        url.searchParams.set('scope', isAdmin() ? 'all' : 'descendants');
        url.searchParams.set('include_owner', '1');

        try{
          const res = await fetch(url.toString(), {
            method:'GET',
            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
            mode:'cors'
          });
          const data = await res.json().catch(()=> ({}));
          if (res.ok && data && data.tags){
            const raw = Array.isArray(data.tags) ? data.tags : [];
            for (const t of raw){
              const rawId = (typeof t === 'string') ? t : (t?.tag_mac || t?.id || t?.mac || t?.tagMac);
              const k = macHex12(rawId);
              if (k) __ALLOWED_TAG_KEYS.add(k);
              else console.warn('[allowed] invalid mac skipped:', rawId);
            }
          } else {
            console.warn('[allowed] non-ok:', res.status, data);
          }
        }catch(e){
          console.error('[allowed] fetch error:', e);
        }finally{
          __ALLOWED_READY = true;
          window.__ALLOWED_TAG_IDS = [...__ALLOWED_TAG_KEYS];
          window.__ALLOWED_READY   = true;
          window.SJUI?.TickerHub?.refreshFilter?.();
        }
      }

      async function prepareAllowedTags(){ await fetchAllowedTagIdsFromServer(); }
      function isAllowedDevice(id){
        if (!id || !__ALLOWED_READY) return false;
        const k = macHex12(id);
        return !!(k && __ALLOWED_TAG_KEYS.has(k));
      }
    // ===== ìœ í‹¸ =====
    const fmtTime = (ms) => new Intl.DateTimeFormat('ko-KR', {
      timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
    }).format(ms);
    const toNum = (v) => (v==null ? null : (Number.isFinite(Number(v)) ? Number(v) : null));
    function pickTs(x){
      let t = toNum(x.timestamp ?? x.ts ?? x.timestamp_epoch ?? x.raw_time ?? x.time);
      if (t==null) return null;
      return (t < 1e12) ? t*1000 : t;
    }
    const badge = (label, cls) => `<span class="inline-flex items-center rounded border px-1.5 py-0.5 text-[11px] ${cls}">${label}</span>`;

    // gw_statue â†’ ë°°ì§€/í‚¤ ë³€í™˜
    function gwStatusBadge(v){
      const raw = (v ?? '').toString().trim();
      const s = raw.toLowerCase();
      if (['0','ok','normal','ì •ìƒ','online'].includes(s)) return {label:'ì •ìƒ', cls:'bg-green-100 text-green-700 border-green-200', key:'ok'};
      if (['1','warn','warning','ê²½ê³ '].includes(s))       return {label:'ê²½ê³ ', cls:'bg-amber-100 text-amber-700 border-amber-200', key:'warn'};
      if (['2','error','ì—ëŸ¬','down','offline'].includes(s))return {label:'ì—ëŸ¬',  cls:'bg-red-100 text-red-700 border-red-200',   key:'error'};
      if (raw==='') return {label:'â€”', cls:'bg-gray-100 text-gray-700 border-gray-200', key:'other'};
      return {label:raw, cls:'bg-gray-100 text-gray-700 border-gray-200', key:'other'};
    }

    // ===== DOM =====
    const $tbody   = document.getElementById('table-body');
    const $count   = document.getElementById('total-count');
    const $search  = document.getElementById('search');
    const $refresh = document.getElementById('refresh-list');
    const $title   = document.getElementById('gw-list-title');

    // ===== ìƒíƒœ =====
    // ì „ê´‘íŒìš© íƒœê·¸ ìƒíƒœ
    const tags = new Map();   // tag_id -> {error_code, ts, lastWsTs, _ws}
    let tagIds = [];

    // ê²Œì´íŠ¸ì›¨ì´ í…Œì´ë¸” ìƒíƒœ
    const gateways = new Map(); // gw_address -> {lat,lng,gw_statue,connected_tag,ts}
    let gwIds = [];

    // ê²€ìƒ‰ì–´
    let searchTerm = '';

    // ===== ê²Œì´íŠ¸ì›¨ì´ í…Œì´ë¸” ë Œë” =====
    function renderTable(){
      const now = Date.now();

      // ì œëª©/ì¹´ìš´íŠ¸
      const list = gwIds.filter(id => {
        const g = gateways.get(id) || {};
        const hay = `${id} ${g.gateway_name||''} ${g.gw_version||''}`.toLowerCase();
        return !searchTerm || hay.includes(searchTerm);
      });

      if ($title) $title.textContent = `ê²Œì´íŠ¸ì›¨ì´ ëª©ë¡ (${list.length})`;
      $count.textContent = list.length ? `í‘œì‹œ: ${list.length}ëŒ€` : '';

      const rows = [];
      for (const id of list){
        const g = gateways.get(id) || {};
        const lat = Number.isFinite(g.lat) ? Number(g.lat).toFixed(5) : 'â€”';
        const lng = Number.isFinite(g.lng) ? Number(g.lng).toFixed(5) : 'â€”';
        const loc = (lat==='â€”' || lng==='â€”') ? 'â€”' : `${lat}, ${lng}`;
        const name = g.gateway_name ?? 'â€”';
        const ver  = g.gw_version ?? 'â€”';
        const tagN = Number.isFinite(g.tag_num) ? g.tag_num : 'â€”';

        rows.push(`
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-2 align-middle"><div class="mono font-medium">${id}</div></td>
            <td class="px-3 py-2 align-middle text-gray-700">${name}</td>
            <td class="px-3 py-2 align-middle text-gray-700">${loc}</td>
            <td class="px-3 py-2 align-middle text-gray-700">${ver}</td>
            <td class="px-3 py-2 align-middle">${tagN}</td>
            <td class="px-3 py-2 align-middle">
              ${
                isAdmin()
                ? `
                  <div class="flex items-center gap-2">
                    <button class="px-2 py-1 border rounded bg-white hover:bg-gray-50 text-xs"
                      data-act="gw-update" data-gw="${id}">ì—…ë°ì´íŠ¸</button>
                    </button>
                  </div>
                `
                : 'â€”'
              }
      </td>
          </tr>
        `);
      }
      $tbody.innerHTML = rows.join('');
    }


    // ===== ë°ì´í„° ë¡œë“œ (íƒœê·¸: ì „ê´‘íŒ) =====
    async function loadTagList(){
      const url = `${API_BASE}/${TAG_COLLECTION}`;
      try{
        const res = await fetch(url, {mode:'cors'});
        const txt = await res.text();
        if (!res.ok){ knownIds=[]; window.knownIds=knownIds; window.updateTicker?.(); return; }
        let data; try{ data = JSON.parse(txt); }catch{ knownIds=[]; window.knownIds=knownIds; window.updateTicker?.(); return; }

        const list = Array.isArray(data?.devices) ? data.devices : (Array.isArray(data) ? data : []);
        const set = new Set(knownIds);
        for (const id of list){
          const key = macHex12(id);
          if (!key) continue;
          if (__ALLOWED_READY && __ALLOWED_TAG_KEYS.size && !__ALLOWED_TAG_KEYS.has(key)) continue;
          set.add(key);
          if (!devices.has(key)) devices.set(key, {});
        }
        knownIds = [...set].sort();
        window.knownIds = knownIds; // ì „ì—­ ë™ê¸°í™”
      }catch(e){
        knownIds=[]; window.knownIds=knownIds;
      }
      window.updateTicker && window.updateTicker();
    }

    async function backfillTagLatest(key12){
      // key12: 12HEX
      if (__ALLOWED_READY && __ALLOWED_TAG_KEYS.size && !__ALLOWED_TAG_KEYS.has(key12)) return;
      const display = macPretty(key12);
      const url = `${API_BASE}/${TAG_COLLECTION}?tag_address=${encodeURIComponent(display)}&days=1&order=desc&limit=${BACKFILL_LIMIT_PER_ID}`;
      try{
        const res = await fetch(url, {mode:'cors'});
        const txt = await res.text();
        if (!res.ok) return;
        let data; try{ data = JSON.parse(txt); }catch{ return; }
        const rows = Array.isArray(data) ? data : (data.items||[]);
        if (!rows.length) return;
        const r  = rows[0];
        const ts = pickTs(r) ?? Date.now();
        const cur = devices.get(key12) || {};
        devices.set(key12, { ...cur, error_code: (r.error_code ?? cur.error_code), ts });
      }catch(e){}
    }

    async function backfillAllTags(concurrency=4){
      const ids = knownIds.slice(); // ì´ë¯¸ 12HEX
      let idx = 0;
      async function worker(){
        while (idx < ids.length){
          const cur = ids[idx++];
          await backfillTagLatest(cur);
        }
      }
      const jobs = Array.from({length: Math.min(concurrency, ids.length)}, worker);
      await Promise.all(jobs);
      window.updateTicker && window.updateTicker();
    }


    // ===== ë°ì´í„° ë¡œë“œ (ê²Œì´íŠ¸ì›¨ì´: í…Œì´ë¸”) =====
    async function loadGatewayList(){
      const url = `${API_BASE}/${GW_COLLECTION}`;
      console.log('Fetching Gateway Data from:', url); // í˜¸ì¶œ ì „ ë¡œê·¸
      try {
          const res = await fetch(url, {mode: 'cors'});
          console.log('Response Status:', res.status); // ìƒíƒœ ì½”ë“œ ë¡œê·¸
          const txt = await res.text(); // ì‘ë‹µ ë³¸ë¬¸ì„ í…ìŠ¤íŠ¸ë¡œ ë°›ê¸°
          console.log('Response Body:', txt); // ì‘ë‹µ ë³¸ë¬¸ì„ ë¡œê·¸ë¡œ ì¶œë ¥

          if (!res.ok) {
              console.log('API Error:', txt); // ì—ëŸ¬ ì‘ë‹µ ë¡œê·¸
              gwIds = [];
              renderTable();
              return;
          }

          let data;
          try {
              data = JSON.parse(txt); // ì‘ë‹µì„ JSONìœ¼ë¡œ ë³€í™˜
          } catch (error) {
              console.log('Error parsing response:', error);
              gwIds = [];
              renderTable();
              return;
          }

          console.log('Parsed Data:', data); // JSONìœ¼ë¡œ ë³€í™˜ëœ ë°ì´í„° í™•ì¸

          // ë°ì´í„° ì²˜ë¦¬
          const list = Array.isArray(data?.gateways) ? data.gateways : [];
          const set = new Set(gwIds);

          for (const x of list) {
              const id = String(x.gw_address ?? x.id ?? x.gateway_id ?? x.gw_id ?? x).trim();
              if (!id) continue;
              set.add(id);

              const prev = gateways.get(id) || {};
              gateways.set(id, {
                  ...prev,
                  gateway_name: x.gateway_name ?? prev.gateway_name,
                  gw_version: x.gw_version ?? prev.gw_version,
                  tag_num: toNum(x.tag_num) ?? prev.tag_num,
                  lat: toNum(x.latitude) ?? prev.lat,
                  lng: toNum(x.longitude) ?? prev.lng,
                  ts: pickTs(x) ?? prev.ts
              });
          }
          gwIds = [...set]; // ì •ë ¬ ìœ ì§€
          renderTable();
      } catch (e) {
          console.error('Error fetching gateway data:', e); // ì—ëŸ¬ ë¡œê·¸ ì¶œë ¥
          gwIds = [];
      }
  }



    async function backfillGatewayLatest(id){
      // ì‹¤ì œ ì¿¼ë¦¬ í‚¤ëŠ” gw_address ê¸°ì¤€
      const url = `${API_BASE}/${GW_COLLECTION}?gw_address=${encodeURIComponent(id)}`;
      try{
        const res = await fetch(url, {mode:'cors'});
        const txt = await res.text();
        if (!res.ok) return;
        let data; try{ data = JSON.parse(txt); }catch{ return; }
        const rows = Array.isArray(data) ? data : (data.items||[]);
        if (!rows.length) return;
        const r = rows[0];
        const ts = pickTs(r) ?? Date.now();
        const obj = gateways.get(id) || {};
        gateways.set(id, {
          ...obj,
          lat: toNum(r.latitude) ?? obj.lat,
          lng: toNum(r.longitude ?? r.longtitude) ?? obj.lng,
          gw_statue: r.gw_statue ?? obj.gw_statue,
          connected_tag: toNum(r.connected_tag ?? r.connted_tag) ?? obj.connected_tag,
          ts
        });
      }catch(e){}
    }
    async function backfillAllGateways(concurrency=4){
      const ids = gwIds.slice();
      let idx = 0;
      async function worker(){
        while (idx < ids.length){
          const cur = ids[idx++];
          await backfillGatewayLatest(cur);
        }
      }
      const jobs = Array.from({length: Math.min(concurrency, ids.length)}, worker);
      await Promise.all(jobs);
      renderTable();
    }

    // ===== WebSocket: íƒœê·¸(ì „ê´‘íŒ) + ê²Œì´íŠ¸ì›¨ì´(í…Œì´ë¸”) ì²˜ë¦¬ =====
    const devices = new Map();
    let knownIds = [];

    // ê³µí†µ ì „ê´‘íŒì—ì„œ ì°¸ì¡°
    window.devices  = devices;
    window.knownIds = knownIds;

    async function backfillTickerLatestFor(key12){
      const addr = macPretty(key12);
      const url = `${API_BASE}/${TAG_COLLECTION}?tag_address=${encodeURIComponent(addr)}&days=1&order=desc&limit=1`;
      try{
        const res  = await fetch(url, {mode:'cors'});
        const data = await res.json().catch(()=>[]);
        const rows = Array.isArray(data) ? data : (data.items||[]);
        if (!rows.length) return;
        const r  = rows[0];
        const ts = pickTs(r) ?? Date.now();
        const cur = devices.get(key12) || {};
        devices.set(key12, { ...cur, error_code:(r.error_code ?? cur.error_code), ts });
      }catch(e){}
    }

    async function backfillTickerAll(concurrency=4){
      const ids = [...__ALLOWED_TAG_KEYS];
      knownIds = ids.slice().sort();
      window.knownIds = knownIds;

      let idx = 0;
      const workers = Array.from({length: Math.min(concurrency, ids.length)}, async ()=>{
        while (idx < ids.length){
          await backfillTickerLatestFor(ids[idx++]);
        }
      });
      await Promise.all(workers);
      window.updateTicker && window.updateTicker();
    }

    function handleWsMessage(raw){
      try{
        const msg   = JSON.parse(raw);
        const rawId = msg.tag_address || msg.device_id || msg.id;
        if (!rawId) return;

        const k = macHex12(rawId);
        if (!k) return;

        if (__ALLOWED_READY && __ALLOWED_TAG_KEYS.size && !__ALLOWED_TAG_KEYS.has(k)) return;

        if (!knownIds.includes(k)) { knownIds.push(k); knownIds.sort(); }

        const prev = devices.get(k) || {};
        const now  = Date.now();
        const err  = (msg.error_code ?? prev.error_code);

        devices.set(k, { ...prev, error_code: err, lastWsTs: now, ts: now });

        // ğŸ”§ [ì„ íƒ] ì—ëŸ¬/ê²½ê³  ì¦‰ì‹œ ì „ê´‘íŒì— í‘¸ì‹œ
        if (err != null && typeof publishAlerts === 'function') {
          publishAlerts(
            [{ text: `íƒœê·¸ ${macPretty(k)} ${(+err===2?'ì—ëŸ¬':+err===1?'ê²½ê³ ':'ìƒíƒœ')}`, level: (+err===2?'error':'warn') }],
            { mode:'append', broadcast:true }
          );
        }

        window.updateTicker && window.updateTicker();
      }catch(e){
        console.error('WS parse error:', e, raw);
      }
    }


    let ws, retry=0;
    function connectWS(){
      ws = new WebSocket(WS_URL);
      ws.onopen = ()=>{ retry=0; };
      ws.onmessage = (ev)=> handleWsMessage(ev.data);
      ws.onclose = ()=> setTimeout(connectWS, Math.min(1000*(++retry), 10000));
      ws.onerror = ()=> ws.close();
    }


    // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
    const normalize = s => String(s||'').trim().toLowerCase();
    document.getElementById('search').addEventListener('input', (e)=>{
      searchTerm = normalize(e.target.value);
      renderTable();
    });
    document.getElementById('refresh-list').addEventListener('click', async ()=>{
      await loadGatewayList();
      await backfillAllGateways();
    });

    $tbody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-act="gw-update"]');
      if (!btn) return;

      if (sessionStorage.getItem('app_is_admin') !== '1') {
        alert('ê´€ë¦¬ìë§Œ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }

      // ì—¬ê¸°ì„œ presigned manifest_url ì„ ì§ì ‘ ì§€ì •(ë˜ëŠ” ì…ë ¥ì°½)
      const manifestUrl ="";

      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = 'ì‹ í˜¸ ì „ì†¡ ì¤‘â€¦';

      try {
        const res = await fetch(UPDATE_API, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'text/plain;charset=UTF-8'
          },
          body: JSON.stringify({ manifest_url: manifestUrl })
        });

        // ì‘ë‹µì„ ì½ì„ ìˆ˜ ìˆìœ¼ë ¤ë©´ ì„œë²„ê°€ ì‹¤ì œë¡œ CORS í—¤ë”ë¥¼ POST ì‘ë‹µì—ë„ ë„£ì–´ì¤˜ì•¼ í•©ë‹ˆë‹¤.
        const txt = await res.text();
        let out = {}; try { out = JSON.parse(txt); } catch {}

        if (!res.ok) throw new Error(out?.error || `HTTP ${res.status}`);
        if (out?.ok !== true) {
          console.warn('Unexpected response:', out);
        }
        alert(out?.message || 'ì—…ë°ì´íŠ¸ ì‹ í˜¸ ì „ì†¡ ì™„ë£Œ!');
      } catch (err) {
        alert('ì‹¤íŒ¨: ' + (err?.message || err));
      } finally {
        btn.disabled = false;
        btn.textContent = original;
      }
    });


    
    function isAdmin(){ try { return sessionStorage.getItem('app_is_admin') === '1'; } catch { return false; } }
    function currentEmail(){ try { return sessionStorage.getItem('app_user_email') || ''; } catch { return ''; } }
    async function getIdToken(){
      return new Promise(resolve=>{
        try{
          const pool = new AmazonCognitoIdentity.CognitoUserPool(window.__POOL__);
          const u = pool.getCurrentUser(); if (!u) return resolve('');
          u.getSession((err,s)=>{ if(err||!s||!s.isValid()) return resolve(''); resolve(s.getIdToken().getJwtToken()); });
        }catch{ resolve(''); }
      });
    }


    // ===== ì‹œì‘ =====
    (async function(){
      // 1) í—ˆìš©ëª©ë¡(allow-list) ë¨¼ì €
      await fetchAllowedTagIdsFromServer();

      // 2) ì „ê´‘íŒ(íƒœê·¸) ì´ˆê¸° ì±„ì›€
      await loadTagList();
      await backfillAllTags();

      // 3) ê²Œì´íŠ¸ì›¨ì´ í…Œì´ë¸”
      await loadGatewayList();
      await backfillAllGateways();

      // 4) ì‹¤ì‹œê°„
      connectWS();

      // 5) í—ˆìš©ëª©ë¡ ì£¼ê¸° ê°±ì‹  + ì „ê´‘íŒ ë¦¬í”„ë ˆì‹œ
      setInterval(async ()=>{
        await fetchAllowedTagIdsFromServer();
        window.SJUI?.TickerHub?.refreshFilter?.();
        window.updateTicker && window.updateTicker();
      }, 60_000);
    })();
  </script>
</body>
</html>
