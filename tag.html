<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- â–¼â–¼â–¼ ë³´í˜¸ í˜ì´ì§€ ê³µí†µ: <head> ë§¨ ìœ„ì— ë„£ê¸° â–¼â–¼â–¼ -->
  <meta charset="UTF-8" />
  <style> html.auth-check { visibility: hidden } </style>
  <style>
  /* ...ì „ê´‘íŒ í˜ì´ë“œì¸ */
  #hdr-rotator{ position:relative; min-height:24px; }
  #hdr-rotator .rot-line{
    position:absolute; inset:0;
    opacity:0; transform:translateY(8px);
    transition:opacity .4s ease, transform .4s ease;
    will-change:opacity,transform;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  #hdr-rotator .rot-line.show{
    opacity:1; transform:translateY(0);
  }
</style>

  <script>
    // UI ê¹œë¹¡ì„ ë°©ì§€: ì¸ì¦ ëë‚  ë•Œê¹Œì§€ ìˆ¨ê¹€
    document.documentElement.classList.add('auth-check');

    // ë¡œê·¸ì¸ í˜ì´ì§€ ê²½ë¡œ (í•„ìš”ì‹œ ìƒëŒ€ê²½ë¡œ ì¡°ì •)
    window.__LOGIN_PAGE__ = 'login.html';

    // Cognito User Pool ì„¤ì •
    window.__POOL__ = {
      UserPoolId: 'ap-northeast-2_jubP19tft', // â† ì‹¤ì œ ê°’
      ClientId:   '2mpr21p7900br0n3p03g8f9ota', // â† ì‹¤ì œ ê°’
    };
  </script>

  <!-- Cognito SDKë“¤ (ìˆœì„œ ì¤‘ìš”) -->
  <script src="aws-cognito-sdk.min.js"></script>
  <script src="amazon-cognito-identity.min.js"></script>

  <!-- ì¸ì¦ ê°€ë“œ -->
  <script>
    (function authGuard() {
      function goLogin() {
        const u = new URL(window.__LOGIN_PAGE__, location.href);
        u.searchParams.set('redirect', location.href); // ë¡œê·¸ì¸ í›„ ëŒì•„ì˜¬ ê³³
        location.replace(u.toString());
      }

      (function waitLib(){
        if (!window.AmazonCognitoIdentity){ return setTimeout(waitLib, 20); }
        try{
          const pool = new AmazonCognitoIdentity.CognitoUserPool(window.__POOL__);

          // ğŸ”¸ ë¸Œë¼ìš°ì € ì„¸ì…˜ í”Œë˜ê·¸ê°€ ì—†ìœ¼ë©´ ê°•ì œ ì¬ë¡œê·¸ì¸
          if (!sessionStorage.getItem('app_session')) {
            const u = pool.getCurrentUser();
            if (u) { try { u.signOut(); } catch(e){} }
            return goLogin();
          }

          const user = pool.getCurrentUser();
          if (!user) return goLogin();

          user.getSession(function(err, session){
            if (err || !session || !session.isValid()) return goLogin();

            try {
              const groups = (session.getIdToken().payload || {})['cognito:groups'] || [];
              sessionStorage.setItem('app_is_admin', groups.includes('admin') ? '1' : '0');
            } catch {}

            // í˜ì´ì§€ í‘œì‹œ
            document.documentElement.classList.remove('auth-check');

            // âœ… ì´ë©”ì¼ ì €ì¥ + ì¸ì‚¬ë§ í‘œì‹œ (ê³µí†µ ì£¼ì… í•¨ìˆ˜ë¡œ í˜¸ì¶œ)
            user.getUserAttributes(function(e, attrs){
              let email = (typeof user.getUsername === 'function') ? user.getUsername() : '';
              if (!e && Array.isArray(attrs)) {
                const em = attrs.find(a => (a.getName && a.getName() === 'email') || a?.Name === 'email');
                if (em) email = (em.getValue ? em.getValue() : em.Value);
              }
              try { sessionStorage.setItem('app_user_email', email); } catch {}
              try { window.__showSidebarGreet && window.__showSidebarGreet(email); } catch {}
            });
          });
        }catch(e){ goLogin(); }
      })();
    })();
  </script>
  <!-- â–²â–²â–² ì—¬ê¸°ê¹Œì§€ê°€ 'ë¬´ì¡°ê±´ ë¡œê·¸ì¸ ë¨¼ì €' ê°€ë“œ â–²â–²â–² -->

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tag Monitor</title>

  <!-- ì•„ì´ì½˜/í°íŠ¸/ìœ í‹¸ -->
  <link rel="shortcut icon" href="https://example-s3-3.s3.ap-northeast-2.amazonaws.com/images.PNG" type="image/x-icon" sizes="16x16">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary:'#1E88E5', secondary:'#F5F6FA' },
          borderRadius: {
            'none':'0px','sm':'4px', DEFAULT:'8px','md':'12px','lg':'16px',
            'xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'
          }
        }
      }
    }
  </script>

  <!-- â˜… ê³µí†µ UI CSS -->
  <link rel="stylesheet" href="./ui-common.css" />

  <style>
    body{font-family:'Noto Sans KR',sans-serif;background:#f8fafc}
    .mono{font-family:'Roboto Mono',monospace}
  </style>
</head>

<body>
  <!-- â˜… ê³µí†µ ë ˆì´ì•„ì›ƒ(sj-shell) + ì‚¬ì´ë“œë°”/ë©”ì¸ -->
  <div class="sj-shell">
    <!-- ê³µí†µ ì‚¬ì´ë“œë°”: ìë™ ë Œë” -->
    <aside class="sj-sidebar" data-sj-sidebar></aside>

    <!-- ë©”ì¸ -->
    <main class="sj-main">
      <!-- ê³µí†µí˜• í—¤ë” -->
      <header class="sj-header">
        <div class="sj-title text-sm">
          
        </div>

        <!-- â˜… ì „ê´‘íŒ(ê³µí†µ ë¡œí…Œì´í„°) -->
        <div data-sj-rotator id="hdr-rotator" class="w-[240px] sm:w-[320px] md:w-[480px]"></div>
      </header>

      <!-- í˜ì´ì§€ ì½˜í…ì¸  -->
      <section class="p-6">
        <div class="mb-4 flex items-center justify-between">
          <h2 class="text-xl font-bold text-gray-800">íƒœê·¸ ëª©ë¡</h2>
          <div class="text-sm text-gray-500"><span id="count">â€”</span></div>
        </div>

        <!-- ê²€ìƒ‰/ì •ë ¬ ë°” -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4 flex flex-wrap gap-3 items-center">
          <div class="flex items-center gap-2">
            <i class="ri-search-line text-gray-500"></i>
            <input id="q" type="text" placeholder="íƒœê·¸ MAC / ì†Œìœ ì ê²€ìƒ‰"
                   class="px-3 py-2 border rounded-md text-sm w-60 outline-none focus:ring-2 focus:ring-primary/30">
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">ì •ë ¬:</label>
            <select id="sort" class="px-3 py-2 border rounded-md text-sm">
              <option value="time_desc">ìµœê·¼ ê°±ì‹  â†“</option>
              <option value="time_asc">ìµœê·¼ ê°±ì‹  â†‘</option>
              <option value="id_asc">ID ì˜¤ë¦„ì°¨ìˆœ</option>
              <option value="id_desc">ID ë‚´ë¦¼ì°¨ìˆœ</option>
              <option value="temp_desc">ì˜¨ë„ â†“</option>
              <option value="batt_desc">ë°°í„°ë¦¬ â†“</option>
            </select>
          </div>
        </div>

        <!-- í‘œ -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 text-gray-600">
              <tr>
                <th class="px-4 py-2 text-left">íƒœê·¸ ID</th>
                <th class="px-4 py-2 text-left">ì†Œìœ ì</th>
                <th class="px-4 py-2 text-left">ì˜¨ë„</th>
                <th class="px-4 py-2 text-left">ë°°í„°ë¦¬</th>
                <th class="px-4 py-2 text-left">ìƒíƒœ</th>
                <th class="px-4 py-2 text-left">ì§€ë„</th>
                <th class="px-4 py-2 text-left">ë§ˆì§€ë§‰ ê°±ì‹ </th>
                <th class="px-4 py-2"></th>
              </tr>
            </thead>
            <tbody id="rows" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
        <!-- â–¼ í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div id="pager" class="px-3 py-3 flex items-center justify-center gap-1 text-sm select-none"></div>
      </section>
    </main>
  </div>

  <!-- â˜… ê³µí†µ UI JS (autoInitë¡œ ì‚¬ì´ë“œë°”/ë¡œí…Œì´í„° ìë™ ë°”ì¸ë”©) -->
  <script type="module" src="./ui-common.js"></script>

  <!-- â˜… ì‚¬ì´ë“œë°” í•­ëª© êµ¬ì„± -->
  <script>
    window.__SJ_SIDEBAR__ = {
      logo: { text: 'Tag Monitor', href: 'design.html', iconSrc: '', version: 'v0.1' },
      search: false,
      sections: [
        { title: 'Main', items: [
          { icon: 'ri-time-line',         label: 'ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ', href: 'design.html',  activeMatch: 'design.html' },
          { icon: 'ri-device-line',       label: 'ë””ë°”ì´ìŠ¤ ìƒì„¸',   href: 'detail.html',  activeMatch: 'detail.html' },
          { icon: 'ri-price-tag-3-line',  label: 'íƒœê·¸',            href: 'tag.html',     activeMatch: 'tag.html' },
          { icon: 'ri-rfid-line',         label: 'ê²Œì´íŠ¸ì›¨ì´',      href: 'gateway.html', activeMatch: 'gateway.html' },
          { icon: 'ri-alarm-warning-line',label: 'ì•ŒëŒ',            href: 'alarm.html',   activeMatch: 'alarm.html' },
          { icon: 'ri-settings-3-line',   label: 'ì„¤ì •',            href: 'setting.html', activeMatch: 'setting.html' }
        ] }
      ],
      initiallyOpen: false
    };
  </script>

  <!-- â˜… ì¸ì‚¬ë§ ìŠ¬ë¡¯ ì£¼ì… (ê³µí†µ ì‚¬ì´ë“œë°” ë Œë” í›„) -->
  <script>
    (function mountGreetSlot(){
      function inject(){
        const root = document.querySelector('[data-sj-sidebar]');
        if (!root || document.getElementById('sidebar-greet')) return;
        const logo = root.querySelector('.sj-sidebar__logo');
        const box  = document.createElement('div');
        box.id = 'sidebar-greet';
        box.className = 'px-4 py-1 text-[12px] text-gray-700 hidden';
        box.innerHTML = '<span id="sidebar-greet-name"></span>ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!';
        // ë¡œê³  ë°”ë¡œ ì•„ë˜ì— ê½‚ê¸°
        if (logo && logo.parentNode) {
          logo.parentNode.insertBefore(box, logo.nextSibling);
        } else {
          root.appendChild(box);
        }
      }
      const run = () => setTimeout(inject, 0); // SJUI.autoInit ì§í›„ ë Œë” ë³´ì¥
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run, { once: true });
      } else {
        run();
      }

      // ì¸ì¦ê°€ë“œ/í˜ì´ì§€ ì–´ë””ì„œë“  í˜¸ì¶œ ê°€ëŠ¥
      window.__showSidebarGreet = function(email){
        try{
          email = email || sessionStorage.getItem('app_user_email') || '';
          const box  = document.getElementById('sidebar-greet');
          const name = document.getElementById('sidebar-greet-name');
          if (box && name && email){ name.textContent = email; box.classList.remove('hidden'); }
        }catch{}
      };
      // í´ë°± 1íšŒ
      setTimeout(()=> window.__showSidebarGreet && window.__showSidebarGreet(), 400);
    })();
  </script>

  <!-- âœ… ê³µí†µ ì „ê´‘íŒ ëª¨ë“ˆ: import + êµ¬ë…/ë°œí–‰ -->
  <script type="module">
    import {
      buildTickerTextsFromDevices,
      publishAlerts,
      subscribeTickerFromOthers,
      macPretty
    } from './ticker-common.js';

    // ëª¨ë“  í˜ì´ì§€ì—ì„œ 1íšŒ: ì™¸ë¶€ ë°œí–‰ì„ ìˆ˜ì‹ 
    subscribeTickerFromOthers();

    function updateTicker() {
      const texts = buildTickerTextsFromDevices({
        devicesMap: window.devices ?? new Map(), // Map(id -> { error_code, ts, ... })
        ids:        window.knownIds ?? [],       // 12HEX ë°°ì—´
        activeMs:   60_000,
        // labeler: (id) => macPretty(id), // ê¸°ë³¸ê°’ì´ macPretty
      });

      // ë¬¸ìì—´ ë¬¸êµ¬ë“¤ì„ ì•ˆì „í•˜ê²Œ ë°œí–‰(ì¤‘ë³µ/ì¿¨ë‹¤ìš´/í˜ì´ë“œ ì œì–´ëŠ” ëª¨ë“ˆì´ ì²˜ë¦¬)
      publishAlerts(
        texts.map(t => ({ text: t, level: 'info' })), // ê°ì²´/ë¬¸ìì—´ ëª¨ë‘ OK
        { mode:'replace', staggerMs:1200, broadcast:true }
      );
    }

    // ì „ì—­ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡
    window.updateTicker = updateTicker;

    // ì´ˆê¸°/ì£¼ê¸° í˜¸ì¶œ
    updateTicker();
    window.__tickerTimer ||= setInterval(updateTicker, 5000);
  </script>

  <!-- â–¼ íƒœê·¸ë³„ ì˜¨ë„ ì„ê³„ê°’ ê³µí†µ(íŒì • ì „ìš© / UI ì—†ìŒ) -->
  <script>
    const TH_NS   = 'temp_th_by_tag_v1';   // detail.htmlì—ì„œ ì“°ë˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê·¸ëŒ€ë¡œ
    const ABS_MIN = -40, ABS_MAX = 85;     // ì„¼ì„œ ì ˆëŒ€ ë²”ìœ„
    const DEF_LOW = 0,   DEF_HIGH = 35;    // ê¸°ë³¸ ì •ìƒ êµ¬ê°„

    const BATT_NS = 'batt_th_by_tag_v1';
    const BATT_DEF_MIN_PCT = 20; // ê¸°ë³¸: 20% ë¯¸ë§Œì´ë©´ 'ì¶©ì „ í•„ìš”'

    // ë‹¤ë¥¸ ê³³ì—ì„œ ì´ë¯¸ ì •ì˜ë¼ ìˆìœ¼ë©´ ë®ì–´ì“°ì§€ ì•Šê¸°
    if (typeof window.macHex12 !== 'function') {
      window.macHex12 = function(raw){
        const s = String(raw||'').trim();
        const hex = s.toUpperCase().replace(/[^0-9A-F]/g, '');
        return /^[0-9A-F]{12}$/.test(hex) ? hex : null;
      };
    }

    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
    function _readAll(){ try{ return JSON.parse(localStorage.getItem(TH_NS) || '{}'); }catch{ return {}; } }

    // íƒœê·¸ë³„ ì„ê³„ê°’ ì½ê¸°
    function getTempThresholdFor(tagId){
      const key = window.macHex12(tagId);
      const all = _readAll();
      const th  = (key && all[key]) ? all[key] : { low:DEF_LOW, high:DEF_HIGH };
      let low  = Number(th.low),  high = Number(th.high);
      if (!Number.isFinite(low))  low  = DEF_LOW;
      if (!Number.isFinite(high)) high = DEF_HIGH;
      low  = clamp(Math.round(low),  ABS_MIN, ABS_MAX);
      high = clamp(Math.round(high), ABS_MIN, ABS_MAX);
      if (low > high){ const t=low; low=high; high=t; }
      return { low, high };
    }

    // íƒœê·¸ë³„ ì„ê³„ê°’ì„ ì‚¬ìš©í•œ ìƒíƒœ íŒì •
    function stateOfTemp(value, tagId){
      const x = Number(value);
      if (!Number.isFinite(x)) return 'â€”';
      if (x < ABS_MIN || x > ABS_MAX) return 'ì´ìƒ';
      const { low, high } = getTempThresholdFor(tagId);
      if (x < low)  return 'ë‚®ìŒ';
      if (x > high) return 'ë†’ìŒ';
      return 'ì •ìƒ';
    }

    // ì „ì••â†’% ë³€í™˜(ì„ í˜•): 0V=0%, 3.3V=100%  (ì…ë ¥ì´ mVë©´ ìë™ Vë¡œ ë³´ì •)
    function battVoltageToPercent(v){
      if (v == null || !Number.isFinite(Number(v))) return null;
      let vv = Number(v);
      if (vv > 20) vv = vv / 1000; // mV â†’ V
      const Vmin = 0, Vmax = 3.3;
      let pct = (vv - Vmin) / (Vmax - Vmin) * 100;
      if (!Number.isFinite(pct)) return null;
      return Math.round(Math.max(0, Math.min(100, pct)));
    }

    // localStorage
    function _battReadAll(){ try{ return JSON.parse(localStorage.getItem(BATT_NS)||'{}'); }catch{ return {}; } }
    function _battWriteAll(obj){ localStorage.setItem(BATT_NS, JSON.stringify(obj)); }

    function getBattThresholdFor(tagId){
      const key = window.macHex12(tagId);
      const all = _battReadAll();
      const th  = (key && all[key]) ? all[key] : { minPct:BATT_DEF_MIN_PCT };
      let minPct = Number(th.minPct);
      if (!Number.isFinite(minPct)) minPct = BATT_DEF_MIN_PCT;
      minPct = Math.min(100, Math.max(0, Math.round(minPct)));
      return { minPct };
    }

    function setBattThresholdFor(tagId, minPct){
      const key = window.macHex12(tagId);
      if (!key) return;
      minPct = Math.min(100, Math.max(0, Math.round(Number(minPct)||BATT_DEF_MIN_PCT)));
      const all = _battReadAll(); all[key] = { minPct }; _battWriteAll(all);
      window.dispatchEvent(new CustomEvent('sj:batt-threshold-changed', { detail:{ id:key, minPct } }));
    }

    // ê°’ë§Œ ë„£ìœ¼ë©´ ì“°ê¸° ì‰¬ìš´ íŒì •(ë¼ë²¨/í¼ì„¼íŠ¸/ì¶©ì „í•„ìš”)
    function stateOfBattByPct(vVolt, tagId){
      const pct = battVoltageToPercent(vVolt);
      if (pct==null) return { label:'â€”', pct:null, need:null, minPct:null };
      const { minPct } = getBattThresholdFor(tagId);
      const need = pct < minPct;
      return { label: need ? 'ì¶©ì „ í•„ìš”' : 'ì •ìƒ', pct, need, minPct };
    }

    // ì „ì—­ ë…¸ì¶œ
    window.getBattThresholdFor = getBattThresholdFor;
    window.setBattThresholdFor = setBattThresholdFor;
    window.battVoltageToPercent = battVoltageToPercent;
    window.stateOfBattByPct = stateOfBattByPct;

    // ë‹¤ë¥¸ íƒ­/í˜ì´ì§€ì—ì„œ ì„ê³„ê°’ ë³€ê²½ë˜ë©´ ì¬ë Œë”
    window.addEventListener('sj:batt-threshold-changed', ()=>{ if (typeof render==='function') render(); });
    window.addEventListener('storage', (e)=>{ if (e.key===BATT_NS && typeof render==='function') render(); });

    // ì™¸ë¶€ì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥
    window.getTempThresholdFor = getTempThresholdFor;
    window.stateOfTemp         = stateOfTemp;
  </script>


  <!-- ===== íƒœê·¸ ëª©ë¡ ë¡œì§ + ì‹¤ì‹œê°„/REST ===== -->
  <script>
    // ===== ì„¤ì • =====
    const WS_URL = "wss://fskxd58gc3.execute-api.ap-northeast-2.amazonaws.com/dev";
    const API_BASE = "https://v9dhc7n563.execute-api.ap-northeast-2.amazonaws.com/dev";
    const COLLECTION_PATH = "calculated_locations";
    const ALLOWED_API = "https://ujoxjrept3.execute-api.ap-northeast-2.amazonaws.com/dev/example-user-ble-tag/allowed";
    const ACTIVE_MS = 60 * 1000;

    // ===== ìœ í‹¸ =====
    const normId = s => String(s || '').toUpperCase().trim();

    // 1) ë‚´ë¶€ í‚¤: 12ìë¦¬ 16ì§„, ì½œë¡  ì—†ìŒ (ì˜ˆ: "AABBCCDDEEFF")
    function macKey(raw) {
      const hex = String(raw||'').toUpperCase().replace(/[^0-9A-F]/g,'');
      return /^[0-9A-F]{12}$/.test(hex) ? hex : null;
    }
    // 2) í‘œì‹œ/ì „ì†¡ìš©: ì½œë¡  í¬í•¨ (ì˜ˆ: "AA:BB:CC:DD:EE:FF")
    function macDisplay(rawOrKey) {
      const k = macKey(rawOrKey);
      return k ? k.match(/.{2}/g).join(':') : String(rawOrKey||'');
    }

    function macHex12(raw){
      const hex = String(raw||'').toUpperCase().replace(/[^0-9A-F]/g,'');
      return /^[0-9A-F]{12}$/.test(hex) ? hex : null;
    }
    function macPretty(raw){
      const h = macHex12(raw);
      return h ? h.match(/.{2}/g).join(':') : String(raw||'');
    }
    const fmtTime = (ms) => ms ? new Intl.DateTimeFormat('ko-KR', {
      timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
    }).format(ms) : 'â€”';
    const toNum = (v) => (v==null ? null : (Number.isFinite(Number(v)) ? Number(v) : null));
    function pickTs(x){
      let t = toNum(x.timestamp ?? x.ts ?? x.timestamp_epoch ?? x.raw_time ?? x.time);
      if (t==null) return null;
      return (t < 1e12) ? t*1000 : t;
    }
    function currentEmail(){ try { return sessionStorage.getItem('app_user_email') || ''; } catch { return ''; } }
    async function getIdToken(){
      return new Promise(resolve=>{
        try{
          const pool = new AmazonCognitoIdentity.CognitoUserPool(window.__POOL__);
          const u = pool.getCurrentUser();
          if (!u) return resolve('');
          u.getSession((err,s)=>{ if(err||!s||!s.isValid()) return resolve(''); resolve(s.getIdToken().getJwtToken());});
        }catch{ resolve(''); }
      });
    }
    const IS_ADMIN = (()=>{ try { return sessionStorage.getItem('app_is_admin') === '1'; } catch { return false; } })();

    // ===== í—ˆìš© íƒœê·¸ =====
    let __ALLOWED_TAG_IDS = [];

    window.__ALLOWED_TAG_IDS = __ALLOWED_TAG_IDS;
    window.__ALLOWED_READY = false;

    let __OWNER_OF = new Map();
    async function fetchAllowedTagIdsFromServer(){
      const me = currentEmail();
      if (!me) return [];
      const token = await getIdToken();
      const url = new URL(ALLOWED_API);
      url.searchParams.set('user_id', me);
      url.searchParams.set('scope', IS_ADMIN ? 'all' : 'descendants');
      url.searchParams.set('include_owner', '1');

      try{
        const res = await fetch(url.toString(), {
          method: 'GET',
          headers: token ? { 'Authorization': `Bearer ${token}` } : {},
          mode: 'cors'
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || !data || !Array.isArray(data.tags)) return [];
        const ids = [];
        __OWNER_OF = new Map();

        for (const t of data.tags){
          const raw = (typeof t==='string') ? t : (t.tag_mac || t.id || t.mac || t.tagMac || '');
          const k = macKey(raw);
          if (k) {
            ids.push(k);                     // â† ì½œë¡  ì—†ëŠ” 12HEXë§Œ ë³´ê´€
            if (t && typeof t!=='string' && t.ownerId) __OWNER_OF.set(k, String(t.ownerId));
          }
        }
        return [...new Set(ids)];
      }catch(e){
        console.error('[allowed] fetch error:', e);
        return [];
      }
    }

    // ===== DOM =====
    const $rows = document.getElementById('rows');
    const $count = document.getElementById('count');
    const $q = document.getElementById('q');
    const $sort = document.getElementById('sort');
    const $pager = document.getElementById('pager');

    // ===== í˜ì´ì§€ë„¤ì´ì…˜ =====
    const PAGE_SIZE = 20;
    let currentPage = 1;

    function pageButton(label, {active=false, disabled=false, dataset={}} = {}){
    const cls = [
      'px-3','py-1','rounded','border',
      active ? 'bg-blue-600 text-white border-blue-600'
            : 'bg-white text-gray-700 hover:bg-gray-50',
      disabled ? 'opacity-50 cursor-not-allowed' : ''
    ].join(' ');
    const dataAttrs = Object.entries(dataset)
      .map(([k,v]) => `data-${k}="${v}"`).join(' ');
    return `<button type="button" class="${cls}" ${disabled?'disabled':''} ${dataAttrs}>${label}</button>`;
  }

  function renderPager(totalPages){
    if (!$pager) return;
    if (totalPages <= 1){ $pager.innerHTML = ''; return; }

    const items = [];
    items.push(pageButton('ì´ì „', { disabled: currentPage===1, dataset:{goto:'prev'} }));

    const maxShow = 7;
    const pages = [];
    if (totalPages <= maxShow){
      for (let i=1;i<=totalPages;i++) pages.push(i);
    } else {
      const add = (n)=>{ if (!pages.includes(n) && n>=1 && n<=totalPages) pages.push(n); };
      add(1); add(2);
      add(currentPage-2); add(currentPage-1); add(currentPage); add(currentPage+1); add(currentPage+2);
      add(totalPages-1); add(totalPages);
      pages.sort((a,b)=>a-b);
    }

    let last = 0;
    pages.forEach(p=>{
      if (last && p-last>1) items.push(`<span class="px-2 text-gray-400">â€¦</span>`);
      items.push(pageButton(String(p), { active:p===currentPage, dataset:{page:p} }));
      last = p;
    });

    items.push(pageButton('ë‹¤ìŒ', { disabled: currentPage===totalPages, dataset:{goto:'next'} }));
    $pager.innerHTML = items.join('');
  }

  $pager?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if (!btn) return;
    const goto = btn.dataset.goto;
    const page = Number(btn.dataset.page);

    if (goto === 'prev' && currentPage > 1){
      currentPage--; render();
    } else if (goto === 'next'){
      currentPage++; render();
    } else if (Number.isFinite(page)){
      currentPage = page; render();
    }
  });

    // ===== ë°ì´í„° ìƒíƒœ =====
    // tags: id -> { id, owner, lat, lng, temperature, battery_voltage, error_code, ts }
    const tags = new Map();

    // â˜… ì „ê´‘íŒ ëª¨ë“ˆì´ ì°¸ì¡°í•  ì „ì—­ ì†ŒìŠ¤
    window.devices  = tags;            // Map
    window.knownIds = __ALLOWED_TAG_IDS; // ë°°ì—´(ê°’ ê°±ì‹  ì‹œ ê°™ì´ ê°±ì‹ í•´ì¤„ ê²ƒ)

    // íƒœê·¸ë³„ ì„ê³„ê°’ì„ ë°˜ì˜í•œ ë±ƒì§€ ìŠ¤íƒ€ì¼
    function tempStateFor(id, t){
      if (t == null || !Number.isFinite(Number(t))) {
        return { label:'â€”', cls:'bg-gray-50 text-gray-500 border-gray-200' };
      }
      const x = Number(t);
      if (x < ABS_MIN || x > ABS_MAX) {
        return { label:'ì´ìƒ', cls:'bg-red-50 text-red-700 border-red-200' };
      }
      const { low, high } = getTempThresholdFor(id);
      if (x < low)  return { label:'ë‚®ìŒ', cls:'bg-amber-50 text-amber-700 border-amber-200' };
      if (x > high) return { label:'ë†’ìŒ', cls:'bg-amber-50 text-amber-700 border-amber-200' };
      return { label:'ì •ìƒ', cls:'bg-green-50 text-green-700 border-green-200' };
    }
    function battStateFor(id, rawVolt){
      const st = stateOfBattByPct(rawVolt, id); // {label, pct, need}
      if (st.pct==null) return { label:'â€”', cls:'bg-gray-50 text-gray-500 border-gray-200', pct:null };
      const cls = st.need
        ? 'bg-amber-50 text-amber-700 border-amber-200'   // ì„ê³„% ë¯¸ë§Œ â†’ ì¶©ì „ í•„ìš”
        : 'bg-green-50 text-green-700 border-green-200';  // ì •ìƒ
      return { label: st.label, cls, pct: st.pct };
    }

    function errorBadge(n){
      const num = Number(n);
      if (!Number.isFinite(num)) return { label:'â€”',  cls:'bg-gray-50 text-gray-500 border-gray-200' };
      if (num===0) return { label:'ì •ìƒ', cls:'bg-green-50 text-green-700 border-green-200' };
      if (num===1) return { label:'ê²½ê³ ', cls:'bg-amber-50 text-amber-700 border-amber-200' };
      if (num===2) return { label:'ì—ëŸ¬', cls:'bg-red-50 text-red-700 border-red-200' };
      return { label:String(num), cls:'bg-gray-50 text-gray-700 border-gray-200' };
    }

    function render() {
      const term = ($q.value || '').trim().toLowerCase();
      const sort = $sort.value;

      const now = Date.now();
      let arr = [];
      for (const key of __ALLOWED_TAG_IDS) {
        const d = tags.get(key) || { id: key };
        const owner = d.owner ? String(d.owner).toLowerCase() : '';
        const searchKey = `${key.toLowerCase()} ${owner}`;
        if (term && !searchKey.includes(term)) continue;
        arr.push(d);
      }

      // ì •ë ¬
      arr.sort((a, b) => {
        if (sort === 'time_desc') return (b.ts || 0) - (a.ts || 0);
        if (sort === 'time_asc')  return (a.ts || 0) - (b.ts || 0);
        if (sort === 'id_asc')    return a.id.localeCompare(b.id);
        if (sort === 'id_desc')   return b.id.localeCompare(a.id);
        if (sort === 'temp_desc') return (b.temperature ?? -Infinity) - (a.temperature ?? -Infinity);
        if (sort === 'batt_desc') return (b.battery_voltage ?? -Infinity) - (a.battery_voltage ?? -Infinity);
        return 0;
      });

      // ===== í˜ì´ì§€ë„¤ì´ì…˜ ê³„ì‚° =====
      const total = arr.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;   // ë°ì´í„° ë³€í™”ì— ë”°ë¥¸ ë³´ì •
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageItems = arr.slice(start, start + PAGE_SIZE);

      // ìƒë‹¨ ì¹´ìš´í„°
      $count.textContent = total
        ? `${total}ê°œ Â· ${currentPage}/${totalPages}í˜ì´ì§€`
        : 'â€”';

      // ë Œë”ë§ (pageItemsë§Œ)
      const rows = [];
      for (const d of pageItems) {
        const id = d.id;                   // ë‚´ë¶€ ID(12HEX)
        const labelId = macPretty(id);     // í™”ë©´ í‘œì‹œìš©
        const owner = d.owner || __OWNER_OF.get(id) || '';

        const t = toNum(d.temperature);
        let vV = null;
        if (d.battery_voltage != null) {
          const raw = Number(d.battery_voltage);
          vV = (raw > 20) ? (raw / 1000) : raw;
        }
        const tempS = tempStateFor(id, t);
        const battS = battStateFor(id, d.battery_voltage);
        const errS  = errorBadge(d.error_code);

        const hasLoc = Number.isFinite(d.lat) && Number.isFinite(d.lng);
        const tsNum = Number.isFinite(d.ts) ? d.ts : NaN;
        const ts    = fmtTime(d.ts);

        const ageMs = Number.isFinite(tsNum) ? (now - tsNum) : Infinity;
        const activeCls = (ageMs <= ACTIVE_MS) ? '' : 'opacity-60';

        rows.push(`
          <tr class="hover:bg-gray-50 ${activeCls}">
            <td class="px-3 py-2 align-middle"><div class="mono font-medium">${labelId}</div></td>
            <td class="px-3 py-2 align-middle text-gray-700">${owner || 'â€”'}</td>
            <td class="px-3 py-2 align-middle">
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center rounded border px-1.5 py-0.5 text-[11px] ${tempS.cls}">${tempS.label}</span>
                <span>${t != null ? `${t} â„ƒ` : 'â€”'}</span>
              </div>
            </td>
            <td class="px-3 py-2 align-middle">
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center rounded border px-1.5 py-0.5 text-[11px] ${battS.cls}">${battS.label}</span>
                <span>
                  ${vV != null ? `${vV.toFixed(2)} V` : 'â€”'}
                  ${battS.pct!=null ? ` (${battS.pct}%)` : ''}
                </span>
              </div>
            </td>
            <td class="px-3 py-2 align-middle">
              <span class="inline-flex items-center rounded border px-1.5 py-0.5 text-[11px] ${errS.cls}">${errS.label}</span>
            </td>
            <td class="px-3 py-2 align-middle text-gray-700">
              <button
                ${hasLoc ? '' : 'disabled'}
                class="px-2 py-1 text-xs rounded-md border bg-white hover:bg-gray-50 inline-flex items-center gap-1 ${hasLoc ? '' : 'opacity-50 cursor-not-allowed'}"
                data-map-id="${id}"
                title="ì§€ë„ ì—´ê¸°">
                <i class="ri-map-pin-line align-middle"></i>
              </button>
            </td>
            <td class="px-3 py-2 align-middle text-gray-700">${ts}</td>
          </tr>
        `);
      }

      $rows.innerHTML = rows.join('');

      // ì§€ë„ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²° (í˜„ì¬ í˜ì´ì§€ í–‰ë§Œ)
      document.querySelectorAll('button[data-map-id]').forEach(btn => {
        btn.onclick = () => {
          if (btn.disabled) return;
          const id = btn.getAttribute('data-map-id');
          const d = tags.get(id);
          if (!d || !Number.isFinite(d.lat) || !Number.isFinite(d.lng)) return;
          const p = new URLSearchParams();
          p.set('devices', id);
          p.set('center', `${d.lat},${d.lng}`);
          p.set('lat', d.lat); p.set('lng', d.lng); p.set('zoom', 16);
          if (Number.isFinite(d.ts)) p.set('ts', d.ts);
          window.open(`gps.html?${p.toString()}`, '_blank');
        };
      });

      // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”
      renderPager(totalPages);

      // ì „ê´‘íŒ ê°±ì‹ (ê³µí†µ ëª¨ë“ˆ ê²½ìœ )
      window.updateTicker && window.updateTicker();
    }


    // ===== ë°ì´í„° ì ì¬ =====
    async function loadLatestForAllowed(){
      const ids = __ALLOWED_TAG_IDS.slice();
      const limit = 1;
      const jobs = ids.map(async (rawId)=>{
        const id = macHex12(rawId) || normId(rawId);
        const key = rawId;                           // ë‚´ë¶€ í‚¤(12HEX)
        const tagAddrParam = macDisplay(key);        // "AA:BB:.."
        const url = `${API_BASE}/${COLLECTION_PATH}?tag_address=${encodeURIComponent(tagAddrParam)}&days=1&order=desc&limit=${limit}`;
        try{
          const res = await fetch(url, {mode:'cors'});
          const data = await res.json().catch(()=> []);
          const rows = Array.isArray(data) ? data : (data.items || []);
          const it = rows[0];
          if (!it) { if (!tags.has(key)) tags.set(key, { id: key }); return; }
          const ts = pickTs(it);
          const temp = toNum(it.temperature ?? it.temp);
          const batt = toNum(it.battery_voltage ?? it.battery);
          const lat  = toNum(it.latitude);
          const lng  = toNum(it.longitude ?? it.longtitude);
          const owner = __OWNER_OF.get(id) || it.ownerId || '';
          tags.set(id, {
            id, owner,
            temperature: temp,
            battery_voltage: batt,
            lat, lng,
            error_code: it.error_code ?? null,
            send_type:  it.send_type  ?? null,
            ts
          });
        }catch(e){
          console.warn('[latest] fail for', id, e);
          if (!tags.has(id)) tags.set(id, { id });
        }
      });

      await Promise.all(jobs);
      render();
    }

    // ===== ì‹¤ì‹œê°„ =====
    let ws, retry=0;
    function handleMessage(raw){
      try{
        const msg = JSON.parse(raw);
        const idRaw = msg.tag_address || msg.device_id || msg.id;
        const key = macKey(idRaw);
        if (!idRaw || !key) return;

        // ê¶Œí•œ í™•ì¸(ê´€ë¦¬ì ì™¸ì—ëŠ” í—ˆìš© ë¦¬ìŠ¤íŠ¸ ì™¸ pass)
        if (!IS_ADMIN && !__ALLOWED_TAG_IDS.includes(key)) return;

        const temp = toNum(msg.temperature);
        const batt = (msg.battery_voltage!=null) ? toNum(msg.battery_voltage)
                    : (msg.battery!=null ? toNum(msg.battery) : null);
        const lat  = toNum(msg.latitude);
        const lng  = toNum(msg.longitude);
        const tsRaw = toNum(msg.timestamp ?? msg.time ?? msg.ts ?? msg.timestamp_epoch) ?? Date.now();
        const ts = tsRaw < 1e12 ? tsRaw*1000 : tsRaw;

        const prev = tags.get(key) || { id: key };
        tags.set(key, {
          ...prev,
          temperature: (temp ?? prev.temperature),
          battery_voltage: (batt ?? prev.battery_voltage),
          lat: (lat ?? prev.lat),
          lng: (lng ?? prev.lng),
          error_code: (msg.error_code ?? prev.error_code),
          send_type:  (msg.send_type  ?? prev.send_type),
          ts
        });

        render();
      }catch(e){
        console.error('WS parse error:', e, raw);
      }
    }
    function connectWS(){
      try{
        ws = new WebSocket(WS_URL);
        ws.onopen = ()=>{ retry=0; };
        ws.onmessage = (ev)=> handleMessage(ev.data);
        ws.onclose = ()=> setTimeout(connectWS, Math.min(1000*(++retry), 10000));
        ws.onerror = ()=> { try{ ws.close(); }catch{} };
      }catch(e){
        console.warn('WS failed', e);
      }
    }

    // ===== ì‹œì‘ =====
    (async function(){
      // ê³µí†µ í—¤ë” ë¡œí…Œì´í„° ì¤€ë¹„(ìë™ ì¥ì°©)
      (function waitSJUI(){ if (!window.SJUI) return setTimeout(waitSJUI, 20); })();

      // í—ˆìš© íƒœê·¸ ë¡œë”©
      __ALLOWED_TAG_IDS = await fetchAllowedTagIdsFromServer();
      window.__ALLOWED_TAG_IDS = __ALLOWED_TAG_IDS;   // ì „ì—­ ë°˜ì˜
      window.__ALLOWED_READY = true;                  // í—ˆìš©ëª©ë¡ ì¤€ë¹„ë¨
      window.knownIds = __ALLOWED_TAG_IDS;            // ì „ê´‘íŒ ë¬¸êµ¬ ìƒì„±ìš©
      // â˜… í—ˆìš© í•„í„° ì¬ì ìš©(ì „ê´‘íŒì—ì„œ ì‚­ì œëœ íƒœê·¸ ì œê±°)
      window.SJUI?.TickerHub?.refreshFilter?.();

      // í—ˆìš© íƒœê·¸ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ í…Œì´ë¸” ë¹„ì›€
      if (__ALLOWED_TAG_IDS.length === 0 && !IS_ADMIN){
        tags.clear();
        render();
        return;
      }

      // ì´ˆê¸° ìµœì‹  ìŠ¤ëƒ…ìƒ·
      await loadLatestForAllowed();

      // ì‹¤ì‹œê°„ ì—°ê²°
      connectWS();

      // ê²€ìƒ‰/ì •ë ¬
      $q.addEventListener('input',  ()=>{ currentPage = 1; render(); });
      $sort.addEventListener('change', ()=>{ currentPage = 1; render(); });

      // ì£¼ê¸°ì  ë¦¬í”„ë ˆì‹œ: 1ë¶„
      setInterval(async ()=>{
        __ALLOWED_TAG_IDS = await fetchAllowedTagIdsFromServer();
        window.__ALLOWED_TAG_IDS = __ALLOWED_TAG_IDS; // ì „ì—­ ë°˜ì˜
        window.knownIds = __ALLOWED_TAG_IDS;          // ì „ê´‘íŒ ë¬¸êµ¬ ìƒì„±ìš©
        // â˜… ê°±ì‹ ë  ë•Œë§ˆë‹¤ ì „ê´‘íŒ ì¬í•„í„°
        window.SJUI?.TickerHub?.refreshFilter?.();
        await loadLatestForAllowed();
      }, 60*1000);
    })();
  </script>
</body>
</html>
